#!/usr/bin/env bash
set -eo pipefail


init_file="init.lua"
persisting=false
testing=false
test_file="minimal_init.lua"
appname="tvim"
clear_instance=false
freeze=false

print_usage() {
    printf "Run a neovim instance with the specified configuration. The Neovim XDG directories are set to temporary directories which are persisted between runs\n"
    printf "unless the --persist flag is set. In this case, the default Neovim XDG directories appended with the appname are used.\n"
    printf "\nPlenary and structlog are cloned into the packpath if they don't exist yet and will always be in the runtime path.\n"
    printf "\nUsage: %s [-a appname] [-i init_file] [--testing] [-t test_file] [-x test_arg] [-c] [-p] [--freeze]\n" "$0"
    printf "\nOptions:\n"
    printf "  -a, --appname APPNAME       Specify the appname to use. Default is 'tvim'. (Optional)\n"
    printf "  -I, --init-file FILENAME    Specify the init file to use. Default is 'init.lua'. (Optional)\n"
    printf "  --testing                   Run tests in headless mode. This enables the -t and -x options. (Optional)\n"
    printf "  -t, --test-file FILENAME    Specify the test file to use. Only valid when --testing is set. Default is 'minimal_init.lua'. (Optional)\n"
    printf "  -x, --test-arg ARG          Specify an argument for the plenary busted lua call. Only valid when --testing is set. (Optional)\n"
    printf "  -r, --remove                Force the script start with a fresh instance of neovim. This will remove the reference to the last /tmp folder\n"
    printf "                              or removes the persisted folders when --persist is set. Consider setting the appname explicitly when you used a different appname before (Optional)\n"
    printf "  --persist                   Use default Neovim's standard user directories instead of temporary directories. (Optional)\n"
    printf "  --freeze                    Copy all files from the /tmp/XDG directories to the real XDG directories. Not to be used with --persist. (Optional)\n"
    printf "  -h, --help                  Show this help message and exit.\n"
}

while (( "$#" )); do
    case "$1" in
        -a|--appname)
            if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
                appname=$2
                shift 2
            else
                echo "Error: Argument for $1 is missing" >&2
                exit 1
            fi
            ;;
        -I|--init-file)
            if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
                init_file=$2
                shift 2
            else
                echo "Error: Argument for $1 is missing" >&2
                exit 1
            fi
            ;;
        --freeze)
            freeze=true
            shift
            ;;
        --testing)
            testing=true
            shift
            ;;
        -t|--test-file)
            if [ "$testing" = true ]; then
                if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
                    test_file=$2
                    shift 2
                else
                    echo "Error: Argument for $1 is missing" >&2
                    exit 1
                fi
            else
                echo "Error: $1 is only valid when --testing is set" >&2
                exit 1
            fi
            ;;
        -x|--test-arg)
            if [ "$testing" = true ]; then
                if [ -n "$2" ] && [ "${2:0:1}" != "-" ]; then
                    test_arg=$2
                    shift 2
                else
                    echo "Error: Argument for $1 is missing" >&2
                    exit 1
                fi
            else
                echo "Error: $1 is only valid when --testing is set" >&2
                exit 1
            fi
            ;;
        -r|--remove)
            clear_instance=true
            shift
            ;;
        --persist)
            persisting=true
            shift
            ;;
        -h|--help)
            print_usage
            exit 0
            ;;
        *)
            PARAMS="$PARAMS $1"
            shift
            ;;
    esac
done

if [ "$freeze" = true ] && [ "$persisting" = true ]; then
    echo "Error: --freeze and --persist modes are mutually exclusive."
    exit 1
fi

if [ "$clear_instance" = true ]; then
    if [ -f /tmp/testnvim/vars.sh ]; then
        rm -f /tmp/testnvim/vars.sh
    fi
    if [ "$persisting" = true ]; then
        rm -rf "$HOME/.local/state/$appname"
        rm -rf "$HOME/.local/share/$appname"
        rm -rf "$HOME/.cache/$appname"
    fi
fi

if [ "$persisting" = false ]; then
    if [ -f /tmp/testnvim/vars.sh ]; then
        source /tmp/testnvim/vars.sh
    else
        TESTNVIM_CACHE_DIR="$(mktemp -d)"
        TESTNVIM_STATE_DIR="$(mktemp -d)"
        TESTNVIM_DATA_DIR="$(mktemp -d)"

        mkdir -p /tmp/testnvim
        echo "export TESTNVIM_CACHE_DIR=$TESTNVIM_CACHE_DIR" > /tmp/testnvim/vars.sh
        echo "export TESTNVIM_STATE_DIR=$TESTNVIM_STATE_DIR" >> /tmp/testnvim/vars.sh
        echo "export TESTNVIM_DATA_DIR=$TESTNVIM_DATA_DIR" >> /tmp/testnvim/vars.sh
    fi
fi

export TESTNVIM_CONFIG_DIR="${TESTNVIM_CONFIG_DIR:-"$HOME/.config"}"
export XDG_STATE_HOME="${TESTNVIM_STATE_DIR:-"$HOME/.local/state"}"
export XDG_CONFIG_HOME="${TESTNVIM_CONFIG_DIR:-"$HOME/.config"}"
export XDG_DATA_HOME="${TESTNVIM_DATA_DIR:-"$HOME/.local/share"}"
export XDG_CACHE_HOME="${TESTNVIM_CACHE_DIR:-"$HOME/.cache"}"
export NVIM_APPNAME="$appname"

declare -xr TESTNVIM_CONFIG_DIR XDG_STATE_HOME XDG_CONFIG_HOME XDG_DATA_HOME XDG_CACHE_HOME NVIM_APPNAME

function freeze_config() {
    # Check if there's any existing directory in the real XDG directories
    if [ -d "$HOME/.local/state/$appname" ] || [ -d "$HOME/.local/share/$appname" ] || [ -d "$HOME/.cache/$appname" ]; then
        echo "Existing directories found in the real XDG directories."
        echo "Would you like to backup and replace them? (y/n)"
        read -r answer

        if [[ "$answer" != "y" ]]; then
            echo "Aborting freeze."
            exit 1
        else
            __backup_dir "$HOME/.local/state/$appname"
            __backup_dir "$HOME/.local/share/$appname"
            __backup_dir "$HOME/.cache/$appname"
        fi
    fi

    # Copy the files from /tmp/XDG_whatever to the real XDG directories
    echo "Freezing configuration..."
    cp -r "$TESTNVIM_STATE_DIR/." "$HOME/.local/state/$appname/"
    cp -r "$TESTNVIM_DATA_DIR/." "$HOME/.local/share/$appname/"
    cp -r "$TESTNVIM_CACHE_DIR/." "$HOME/.cache/$appname/"
    echo "Freeze complete."
}

echo "appname: $NVIM_APPNAME"
echo "cache dir: $XDG_CACHE_HOME"
echo "state dir: $XDG_STATE_HOME"
echo "data dir: $XDG_DATA_HOME"

if [ -n "$PARAMS" ]; then
    echo "Neovim parameters: $PARAMS"
fi

# clone the plugins when they don't exist yet
mkdir -p "${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt"
if [ ! -d "${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt/plenary" ]; then
    git clone https://github.com/nvim-lua/plenary.nvim.git "${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt/plenary"
fi
if [ ! -d "${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt/structlog" ]; then
    git clone https://github.com/Tastyep/structlog.nvim.git "${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt/structlog"
fi

function test_nvim() {
    # shellcheck disable=SC2086
    nvim -u "${XDG_CONFIG_HOME}/${NVIM_APPNAME}/tests/minimal_init.lua" \
        --cmd "set runtimepath+=${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt/plenary" \
        --cmd "set runtimepath+=${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt/structlog" \
        "$@" $PARAMS
}

function run_nvim() {
    # shellcheck disable=SC2086
    nvim -u "${XDG_CONFIG_HOME}/${NVIM_APPNAME}/${init_file}" \
        --cmd "set runtimepath+=${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt/plenary" \
        --cmd "set runtimepath+=${XDG_STATE_HOME}/${NVIM_APPNAME}/after/pack/lazy/opt/structlog" \
        $PARAMS
}

function setup() {
    if [ "$freeze" = true ]; then
        freeze_config
        exit 0
    fi

    if [ "$testing" = true ]; then
        if [ -n "$test_arg" ]; then
            test_nvim --headless -c "lua require('plenary.busted').run('$test_arg')"
        else
            test_nvim --headless -c "PlenaryBustedDirectory tests/specs { minimal_init = './tests/$test_file' }"
        fi
    else
        run_nvim
    fi
}

setup
